# 멀티쓰레딩

Overlapped모델을 보기전에 잠시 멀티스레딩을 복습 겸 정리해놓으려고 한다.  
진짜 깊이 파려면 operating systems three easy pieces를 추천한다.

## 프로그램과 프로세스

우리가 흔히 말하는 프로그램은 컴퓨터에서 실행되는 명령어 모음이 들어 있는 데어터 덩어리를  
의미하며 크게 코드와 데이터로 구성되어 있다. 평소에는 디스크 같은 저장소에 있다가 실행하면  
RAM에 탑재된다. 이를 프로세스라고 한다. 프로세스 메모리에는 힙과 스택이라는 공간도 존재한다.  
프로세스가 여러 개 실행되는 걸 멀티 프로세싱이라고 한다. 각 프로세스간에 메모리 공간은 기본  
적으로 접근이 불가하다.

![win32 가상메모리 구조](https://i.sstatic.net/kHVeQ.png)  
![가상메모리](https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Virtual_memory.svg/220px-Virtual_memory.svg.png)

## 스레드

보통 OS는 스레드 기능을 제공한다. 스레드도 프로세스처럼 명령어를 한 줄씩 실행하는 기본단위이다.  
모든 프로세스는 유일한 스레드, 메인 스레드가 있고 그 안에서 프로그램이 실행된다. 물론 스레드를  
추가 생성하는 것도 가능하다.

스레드가 없던 옛날에는 프로세스가 실행의 최소단위 였다고한다. 다만 멀티프로세스 기반의 단점이  
있었는 데,

- 프로세스 생성과정의 부담
- 프로세스간 통신에 별도의 IPC기법을 적용
- 프로세스 컨텍스트 스위칭의 부담.

이를 극복하면서 나온 것이 쓰레드다. 쓰레드간의 데이터 교환에 특별한 기법이 필요없고 컨텍스트 스위칭이  
비교적 가볍다. 쓰레드는 힙과 데이터 영역을 공유하는 대신 스택이 개별적으로 존재한다.

여러 프로세스 혹은 여러 스레드가 동시에 동작하는 것은 착각이다. 일정시간마다 스레드들을 교대로 실행하며  
이 과정중에 발생하는 것이 컨텍스트 스위칭이다. 재개할 스레드의 상태를 복원하는 데 이러한 연산도 많아지면  
부담이 되므로 스레드가 많다고 능사가 아니다. cpu의 코어가 그 개수만큼 있따면 스레드를 병렬 실행 가능하다.

### 쓰레드 생성하기

C++ 11이전에는 OS에 의존적인 API를 사용해야 했지만, 다행히 Thread 관련 부분이 C++표준에 들어왔다.  
표준 쓰레드는 이동(move)연산은 가능하지만 복사는 불가능하다.

thread 생성자는 인자로 다른함수와 그 함수의 인자를 받는다. 이 함수는 해당 스레드가 최초로 실행할  
함수이다. 해당 함수가 끝나면 쓰레드도 같이 끝난다. 템플릿으로 되어있어서 어떠한 콜러블 타입도 가능  
하다. fuctor던 람다든.

```c++
#include <thread>
#include <iostream>
void PrintHello()
{
	std::cout << "Hello" << std::endl;
}
int main()
{
	std::thread t(PrintHello);
    //t = std::thread (PrintHello); 도 가능
}
```

스레드는 실행순서가
근데 메인 스레드가 먼저 끝나버리면 프로세스는 종료하지 않고 남아있게 된다. 좀비프로세스가 된 것이다.  
메인스레드에서 책임지고 기다려야한다. 기다리는 함수는 여러 개가 있는데 join()을 쓸 것이다.  
join함수는 쓰레드개체가 끝날 때까지 현재 쓰레드를 멈춰 놓는다.

```c++
int main()
{
	std::thread t(PrintHello);

	t.join();
}
```

정상종료됨을 확인할 수 있다.

### std::thread의 주요함수들

- get_id() : 쓰레드 고유의 id를 반환한다. 단, 1 2 3 4 이렇게 늘어나는건 아니다.

```c++
std::thread::id threadID = t.get_id();
```

- detach() : join()의 반대격 되는 함수. 쓰레드 개체에서 쓰레드를 뗴어넨다. 뗴어진 쓰레드는  
  메인 쓰레드와 무관하게 독립적으로 실행된다. 이후 get_id하면 0을 반환한다.

- joinable() : 쓰레드개체에 연동된 쓰레드가 있는 지 확인해줌.
